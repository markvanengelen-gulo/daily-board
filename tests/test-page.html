<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Provider Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #4285F4;
        }
        button {
            background: #4285F4;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #357ae8;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ðŸ”„ Google Drive Public Sync Provider Test</h1>
    
    <div class="container">
        <h2>Test Configuration</h2>
        <div class="test-section">
            <label for="fileId">Google Drive File ID:</label>
            <input type="text" id="fileId" placeholder="Enter Google Drive File ID (e.g., 1AzWSa3AeJQJX3zjm4DEUN5TWY_sCakyq)" value="1AzWSa3AeJQJX3zjm4DEUN5TWY_sCakyq">
            
            <label for="shareUrl">Or paste full Google Drive Share URL:</label>
            <input type="text" id="shareUrl" placeholder="https://drive.google.com/file/d/FILE_ID/view?usp=sharing">
            
            <button onclick="extractFileId()">Extract File ID from URL</button>
            <button onclick="setFileId()">Set File ID</button>
        </div>
    </div>

    <div class="container">
        <h2>Run Tests</h2>
        <div class="test-section">
            <button onclick="testProviderInitialization()">1. Test Provider Initialization</button>
            <button onclick="testFileIdExtraction()">2. Test File ID Extraction</button>
            <button onclick="testCheckAvailability()">3. Test Availability Check</button>
            <button onclick="testFetchData()">4. Test Fetch Data</button>
            <button onclick="testUpdateData()">5. Test Update Data (Read-Only)</button>
            <button onclick="runAllTests()">â–¶ Run All Tests</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
    </div>

    <div class="container">
        <h2>Test Results</h2>
        <div id="results">Ready to run tests...</div>
    </div>

    <!-- Load sync providers -->
    <script src="sync-providers.js"></script>
    
    <script>
        let provider = null;
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'success': 'âœ“',
                'error': 'âœ—',
                'info': 'â„¹'
            }[type] || 'â„¹';
            
            results.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        function extractFileId() {
            const url = document.getElementById('shareUrl').value;
            if (!url) {
                log('Please enter a Google Drive share URL', 'error');
                return;
            }
            
            const fileId = GoogleDrivePublicSyncProvider.extractFileIdFromUrl(url);
            if (fileId) {
                document.getElementById('fileId').value = fileId;
                log(`Extracted File ID: ${fileId}`, 'success');
            } else {
                log('Could not extract file ID from URL', 'error');
            }
        }
        
        function setFileId() {
            const fileId = document.getElementById('fileId').value;
            if (!fileId) {
                log('Please enter a file ID', 'error');
                return;
            }
            
            if (!provider) {
                provider = new GoogleDrivePublicSyncProvider();
            }
            
            provider.setFileId(fileId);
            localStorage.setItem('googleDrivePublicFileId', fileId);
            log(`File ID set to: ${fileId}`, 'success');
        }
        
        async function testProviderInitialization() {
            log('Testing provider initialization...');
            try {
                provider = new GoogleDrivePublicSyncProvider();
                log(`Provider created: ${provider.name}`, 'success');
                log(`Default File ID: ${provider.config.fileId}`, 'info');
                log(`Cache timeout: ${provider.cacheTimeout}ms`, 'info');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }
        
        async function testFileIdExtraction() {
            log('Testing file ID extraction...');
            const testUrls = [
                'https://drive.google.com/file/d/1AzWSa3AeJQJX3zjm4DEUN5TWY_sCakyq/view?usp=sharing',
                'https://drive.google.com/file/d/testFileId123/view',
                'https://drive.google.com/open?id=anotherFileId456',
                'https://example.com/invalid-url'
            ];
            
            for (const url of testUrls) {
                const fileId = GoogleDrivePublicSyncProvider.extractFileIdFromUrl(url);
                if (fileId) {
                    log(`âœ“ Extracted from ${url}: ${fileId}`, 'success');
                } else {
                    log(`âœ— Could not extract from ${url}`, 'info');
                }
            }
        }
        
        async function testCheckAvailability() {
            log('Testing availability check...');
            if (!provider) {
                provider = new GoogleDrivePublicSyncProvider();
            }
            
            const fileId = document.getElementById('fileId').value;
            if (fileId) {
                provider.setFileId(fileId);
            }
            
            try {
                log('Checking if file is accessible...', 'info');
                const isAvailable = await provider.checkAvailability();
                
                if (isAvailable) {
                    log('Provider is available and file is accessible!', 'success');
                } else {
                    log('Provider is not available or file is not accessible', 'error');
                }
            } catch (error) {
                log(`Error checking availability: ${error.message}`, 'error');
            }
        }
        
        async function testFetchData() {
            log('Testing data fetch...');
            if (!provider) {
                provider = new GoogleDrivePublicSyncProvider();
            }
            
            const fileId = document.getElementById('fileId').value;
            if (fileId) {
                provider.setFileId(fileId);
            }
            
            try {
                log('Fetching data from Google Drive...', 'info');
                const data = await provider.fetchData();
                
                log('Data fetched successfully!', 'success');
                log(`Data structure: ${JSON.stringify(data, null, 2).substring(0, 500)}...`, 'info');
                
                // Validate structure
                if (data.dateEntries && data.tabs && data.listItems) {
                    log('Data structure is valid!', 'success');
                } else {
                    log('Warning: Data structure may be incomplete', 'error');
                }
            } catch (error) {
                log(`Error fetching data: ${error.message}`, 'error');
            }
        }
        
        async function testUpdateData() {
            log('Testing update data (read-only mode)...');
            if (!provider) {
                provider = new GoogleDrivePublicSyncProvider();
            }
            
            try {
                const testData = {
                    dateEntries: {},
                    tabs: [],
                    listItems: {}
                };
                
                const result = await provider.updateData(testData);
                
                if (result === false) {
                    log('Update correctly returned false (read-only mode)', 'success');
                } else {
                    log('Warning: Update should return false for read-only provider', 'error');
                }
            } catch (error) {
                log(`Error testing update: ${error.message}`, 'error');
            }
        }
        
        async function runAllTests() {
            clearResults();
            log('=== Running All Tests ===\n', 'info');
            
            await testProviderInitialization();
            log('');
            
            await testFileIdExtraction();
            log('');
            
            await testCheckAvailability();
            log('');
            
            await testFetchData();
            log('');
            
            await testUpdateData();
            log('');
            
            log('=== All Tests Complete ===', 'success');
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            log('Test page loaded. Ready to test Google Drive Public Sync Provider!', 'success');
            log('Default File ID is pre-configured. Click "Run All Tests" to start.', 'info');
        });
    </script>
</body>
</html>
